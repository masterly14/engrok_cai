generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id              String  @id @default(uuid()) @db.Uuid
  userId          String  @db.Uuid
  prompt          String
  name            String
  backgroundSound String?
  firstMessage    String
  vapiId          String? @unique
  voiceId         String?
  User            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PhoneNumber {
  id              String   @id @default(uuid()) @db.Uuid
  provider        String
  number          String
  extension       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  userId          String   @db.Uuid
  name            String?  @default("nuevo-numero")
  sipPassword     String?
  sipUri          String?
  sipUsername     String?
  twilioAccountId String?
  twilioAuthToken String?
  vapiId          String?  @unique @db.Uuid
  credentialId    String?  @db.Uuid
  assistantId     String?  @db.Uuid
  workflowId      String?  @db.Uuid
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatAgent {
  id                        String            @id @default(uuid()) @db.Uuid
  name                      String
  isActive                  Boolean           @default(false)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  userId                    String            @db.Uuid
  whatsappAccessToken       String
  whatsappBusinessAccountId String
  whatsappPhoneNumber       String
  whatsappPhoneNumberId     String            @unique
  isTestNumber              Boolean           @default(false)
  hasSeenTestWarning        Boolean           @default(false)
  activeWorkflowId          String?           @db.Uuid
  user                      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  chatContacts              ChatContact[]
  chatSessions              ChatSession[]
  workflows                 ChatWorkflow[]
  messages                  Message[]
  MessageTemplate           MessageTemplate[]
}

model Workflow {
  id           String   @id @default(uuid()) @db.Uuid
  name         String
  vapiId       String?  @unique
  tools        Json?
  workflowJson Json?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String   @db.Uuid
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ChatWorkflow {
  id              String            @id @default(uuid()) @db.Uuid
  name            String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  agentId         String?           @db.Uuid
  workflow        Json
  userId          String?           @db.Uuid
  sessions        ChatSession[]
  agent           ChatAgent?        @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user            User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  WorkflowTrigger WorkflowTrigger[]

  @@unique([name, agentId, userId])
}

model ChatContact {
  id          String        @id @default(uuid()) @db.Uuid
  phone       String        @unique
  name        String?
  createdAt   DateTime      @default(now())
  chatAgentId String        @db.Uuid
  updatedAt   DateTime      @updatedAt
  chatAgent   ChatAgent     @relation(fields: [chatAgentId], references: [id], onDelete: Cascade)
  sessions    ChatSession[]
  messages    Message[]
}

model ChatSession {
  id            String        @id @default(cuid())
  contactId     String        @db.Uuid
  workflowId    String        @db.Uuid
  currentNodeId String
  chatAgentId   String        @db.Uuid
  variables     Json          @default("{}")
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  status        SessionStatus @default(ACTIVE)
  chatAgent     ChatAgent     @relation(fields: [chatAgentId], references: [id], onDelete: Cascade)
  contact       ChatContact   @relation(fields: [contactId], references: [id], onDelete: Cascade)
  workflow      ChatWorkflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([contactId, status])
}

model Connection {
  id                String   @id @default(uuid()) @db.Uuid
  connectionId      String
  providerConfigKey String?
  authMode          String
  endUserId         String
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  userId            String   @db.Uuid
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model KnowledgeBase {
  id           String   @id @default(uuid()) @db.Uuid
  trieveApiKey String
  vapiId       String?  @unique
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  userId       String   @db.Uuid
  credentialId String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Message {
  waId          String       @unique
  from          String
  to            String
  timestamp     DateTime
  type          MessageType
  textBody      String?
  metadata      Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  id            String       @id @default(uuid()) @db.Uuid
  chatAgentId   String       @db.Uuid
  chatContactId String?      @db.Uuid
  chatAgent     ChatAgent    @relation(fields: [chatAgentId], references: [id], onDelete: Cascade)
  chatContact   ChatContact? @relation(fields: [chatContactId], references: [id], onDelete: Cascade)

  @@index([from])
  @@index([timestamp])
  @@index([chatAgentId])
}

model Lead {
  id          String   @id @default(uuid())
  name        String
  company     String
  email       String
  phone       String
  status      String?
  tags        String[]
  lastContact String
  notes       String?
  value       Float?
  userId      String   @db.Uuid
  stageId     String
  stage       Stage    @relation(fields: [stageId, userId], references: [id, userId], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([stageId, userId])
}

model Stage {
  name   String
  color  String
  userId String @db.Uuid
  id     String
  leads  Lead[]
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([id, userId])
  @@unique([name, userId])
}

model Tag {
  name   String
  color  String
  userId String @db.Uuid
  id     String @id @default(uuid()) @db.Uuid
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([name, userId])
}

model Call {
  id                  String    @id @default(uuid()) @db.Uuid
  vapiId              String?   @unique
  type                String
  orgId               String?
  createdAt           DateTime
  updatedAt           DateTime
  startedAt           DateTime?
  endedAt             DateTime?
  status              String
  endedReason         String?
  cost                Float?
  costBreakdown       Json?
  costs               Json[]
  phoneCallProvider   String?
  phoneCallTransport  String?
  phoneCallProviderId String?
  messages            Json[]
  assistantId         String?
  assistantOverrides  Json?
  squadId             String?
  workflowId          String?
  phoneNumberId       String?
  customerId          String?
  destination         Json?
  artifactPlan        Json?
  analysis            Json?
  monitor             Json?
  artifact            Json?
  schedulePlan        Json?
  transport           Json?
  name                String?

  @@map("calls")
}

model Subscription {
  id                 String    @id @default(uuid()) @db.Uuid
  planId             String    @db.Uuid
  status             String
  userId             String    @db.Uuid
  lemonSqueezyId     String    @unique
  email              String
  endsAt             String?
  isPaused           Boolean   @default(false)
  isUsageBased       Boolean   @default(false)
  name               String
  orderId            Int
  price              String
  renewsAt           String?
  statusFormatted    String
  subscriptionItemId String?   @default(uuid())
  trialEndsAt        String?
  createdAt          DateTime  @default(now())
  currentCredits     Int       @default(0)
  cycleEndAt         DateTime?
  updatedAt          DateTime
  plan               Plan      @relation(fields: [planId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Plan {
  id                         String         @id @default(uuid()) @db.Uuid
  name                       String
  price                      String
  interval                   String?
  description                String?
  intervalCount              Int?
  isUsageBased               Boolean        @default(false)
  productId                  Int
  productName                String?
  sort                       Int?
  trialInterval              String?
  trialIntervalCount         Int?
  variantId                  Int            @unique
  chatCreditsPerConversation Int            @default(5)
  creditsPerCycle            Int            @default(0)
  overageChatUsd             Float?         @default(0.07)
  overageVoiceUsd            Float?         @default(0.17)
  ui                         Json?
  voiceCreditsPerMinute      Int            @default(11)
  subscriptions              Subscription[]
}

model Transaction {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  amount    Float
  type      String
  status    String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Integration {
  id             String              @id @default(uuid()) @db.Uuid
  userId         String              @db.Uuid
  provider       IntegrationProvider
  status         IntegrationStatus   @default(ACTIVE)
  accessToken    String?
  refreshToken   String?
  tokenExpiresAt DateTime?
  scopes         String[]
  metadata       Json?
  lastSyncedAt   DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  user           User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([provider])
  @@index([status])
}

/// ---------------------------------------------
/// Lemon Squeezy – Subscription billing (SaaS)
/// ---------------------------------------------
model LsPlan {
  id            String           @id @default(uuid()) @db.Uuid
  storeId       Int
  productId     Int
  variantId     Int              @unique
  name          String
  /// price in cents
  price         Int
  interval      String?
  intervalCount Int?
  isUsageBased  Boolean          @default(false)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  subscriptions LsSubscription[]
}

model LsSubscription {
  id               String               @id @default(uuid()) @db.Uuid
  lsSubscriptionId Int                  @unique
  userId           String               @db.Uuid
  planId           String               @db.Uuid
  status           LsSubscriptionStatus
  renewsAt         DateTime?
  endsAt           DateTime?
  trialEndsAt      DateTime?
  isPaused         Boolean              @default(false)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  plan             LsPlan               @relation(fields: [planId], references: [id], onDelete: Cascade)
  user             User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([planId])
}

model Credit {
  id     String @id @default(cuid())
  userId String
}

model User {
  id                           String            @id @db.Uuid
  clerkId                      String            @unique
  email                        String            @unique
  name                         String?
  createdAt                    DateTime          @default(now())
  updatedAt                    DateTime          @default(now())
  amountCredits                Int
  totalConversations           Int               @default(0)
  totalAverageDuration         Int               @default(0)
  totalCost                    Int               @default(0)
  initialAmountCredits         Int               @default(1000)
  nangoConnectSessionExpiresAt DateTime?
  nangoConnectSessionToken     String?
  plan                         String?
  temporalVariantId            String?
  AccessToken                  AccessToken[]
  agents                       Agent[]
  chatAgents                   ChatAgent[]
  chatWorkflows                ChatWorkflow[]
  connections                  Connection[]
  CreditLedger                 CreditLedger[]
  integrations                 Integration[]
  knowledgeBases               KnowledgeBase[]
  leads                        Lead[]
  lsSubscriptions              LsSubscription[]
  Notification                 Notification[]
  phoneNumbers                 PhoneNumber[]
  stages                       Stage[]
  subscriptions                Subscription[]
  tags                         Tag[]
  transactions                 Transaction[]
  UsageEvent                   UsageEvent[]
  workflows                    Workflow[]
  WorkflowTrigger              WorkflowTrigger[]
}

model AccessToken {
  id          String   @id @db.Uuid
  userId      String   @db.Uuid
  name        String
  accessToken String   @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, name])
}

model CreditLedger {
  id        String           @id @db.Uuid
  userId    String           @db.Uuid
  delta     Int
  type      CreditLedgerType
  meta      Json?
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model MessageTemplate {
  id                 String           @id @db.Uuid
  name               String
  language           String
  category           TemplateCategory
  status             TemplateStatus   @default(PENDING)
  whatsappTemplateId String?          @unique
  components         Json
  createdAt          DateTime         @default(now())
  updatedAt          DateTime
  agentId            String           @db.Uuid
  ChatAgent          ChatAgent        @relation(fields: [agentId], references: [id], onDelete: Cascade)

  @@unique([name, language, agentId])
}

model Notification {
  id        String           @id
  userId    String           @db.Uuid
  type      NotificationType
  read      Boolean          @default(false)
  message   String
  link      String?
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UsageEvent {
  id             String    @id @db.Uuid
  userId         String    @db.Uuid
  kind           UsageKind
  quantity       Int
  creditsCharged Int
  externalRef    String?
  meta           Json?
  createdAt      DateTime  @default(now())
  User           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, kind])
}

model UserAssets {
  id        String   @id @db.Uuid
  userId    String   @db.Uuid
  type      String
  name      String
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime
}

model WorkflowTrigger {
  id           String       @id @db.Uuid
  token        String       @unique
  userId       String       @db.Uuid
  workflowId   String       @db.Uuid
  connectionId String?      @db.Uuid
  syncName     String?
  provider     String
  mapping      Json
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  User         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  ChatWorkflow ChatWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, provider, connectionId])
  @@index([connectionId])
  @@index([provider])
}

enum IntegrationProvider {
  FACEBOOK
  GOOGLE_CALENDAR
  GOOGLE_SHEETS
  CAL_COM
  HUBSPOT
  AIRTABLE
}

enum IntegrationStatus {
  ACTIVE
  INACTIVE
  ERROR
  PENDING
  EXPIRED
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  VIDEO
  DOCUMENT
  LOCATION
  CONTACTS
  BUTTON
  INTERACTIVE
}

enum TYPE_AGENT {
  outbound
  inbound
  widget
}

enum TYPE_CHAT_AGENT {
  SALES
}

enum OrderStatus {
  PENDING
  APPROVED
  FAILED
  CANCELLED
}

enum TemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LsSubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
  TRIALING
}

enum CreditLedgerType {
  debit
  credit
  reset
  rollover
}

enum NotificationType {
  HANDOVER_REQUEST
  BILLING_ISSUE
  TEMPLATE_APPROVED
}

enum SessionStatus {
  ACTIVE
  COMPLETED
  NEEDS_ATTENTION
}

enum TemplateCategory {
  UTILITY
  MARKETING
  AUTHENTICATION
}

enum UsageKind {
  voice
  chat
}
